<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宠物屋</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" defer></script>
    <script src="{{ url_for('static', path='js/xlsx.full.min.js') }}" defer></script>
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
    <script>
        window.STATIC_BASE_URL = "{{ app_config.staticBase }}";
        window.APP_CONFIG = {{ app_config | tojson | safe }};
    </script>
</head>
<body class="has-footer">
    <div class="container">
        <h1 id="main-title">🐾 宠物屋 🏠</h1>

        <div id="class-mode" class="main-content-wrapper" style="display:none;">
            <h2>选择班级</h2>
            <div id="class-card-grid" class="class-card-grid"></div>
        </div>

        <div id="setup-mode" class="main-content-wrapper" style="display:none;">
            <h2 id="setup-title">设置学生名单</h2>
            <textarea id="student-input" placeholder="可一次性粘贴多个学生姓名，请用换行、空格或逗号分隔"></textarea>
            <div class="setup-buttons">
                <button id="save-students-btn">保存名字</button>
                <button id="enter-garden-btn">进入宠物屋</button>
            </div>
            <div class="student-list">
                <h3>当前学生名单</h3>
                <div id="existing-students"></div>
            </div>
            <div class="group-management">
                <h3>小组管理</h3>
                <div class="group-management-header">
                    <input type="text" id="group-name-input" placeholder="输入新的小组名">
                    <button id="create-group-btn">创建小组</button>
                </div>
                <div id="groups-display-area"></div>
            </div>
            <div class="shop-management">
                <h3>爱心商城管理</h3>
                <div class="shop-management-header">
                    <input type="text" id="prize-name-input" placeholder="输入奖品名称">
                    <input type="number" id="prize-cost-input" placeholder="所需爱心">
                    <input type="number" id="prize-stock-input" placeholder="库存(不填=无限)">
                    <button id="add-prize-btn">添加奖品</button>
                </div>
                <div id="prize-list-display-area"></div>
            </div>
            <div class="pet-growth-settings">
                <h3>宠物成长设置</h3>
                <div class="pet-growth-form">
                    <div class="form-group">
                        <label for="level2-threshold-input">升级到LV2所需爱心数</label>
                        <input type="number" id="level2-threshold-input" min="4" value="4" step="4" max="20">
                        <small>必须是4的倍数</small>
                    </div>
                    <div class="form-group">
                        <label for="level3-threshold-input">升级到LV3所需爱心数</label>
                        <input type="number" id="level3-threshold-input" min="8" value="8" step="4" max="24">
                        <small>必须大于LV2且是4的倍数</small>
                    </div>
                </div>
                <button id="save-growth-settings-btn" class="save-settings-btn">保存成长设置</button>
            </div>
            <div class="data-management">
                <h3>数据管理</h3>
                <div class="data-management-buttons">
                    <button id="import-data-btn">导入数据 (.xlsx)</button>
                    <button id="export-data-btn">导出数据 (.xlsx)</button>
                    <input type="file" id="data-file-input" accept=".xlsx,.xls" style="display:none;">
                </div>
            </div>
            <div class="danger-zone">
                <button id="reset-all-btn">本班进度归零</button>
            </div>
            <button id="back-to-class-select-btn">返回班级选择</button>
        </div>

        <div id="game-mode" style="display:none;">
            <div class="header-controls">
                <div class="goal-title-wrapper">
                    <h2 id="current-class-display"></h2>
                    <div class="game-header-buttons">
                        <button id="undo-btn" disabled>撤销操作</button>
                        <button id="switch-class-btn">切换班级</button>
                    </div>
                </div>
                <h2>目标</h2>
                <textarea id="daily-goal" placeholder="请输入今日目标..."></textarea>
                <div id="selection-controls" class="selection-controls">
                    <button id="toggle-select-mode-btn">多选互动</button>
                    <button id="select-all-btn" style="display:none;">全选</button>
                    <button id="water-selected-btn" style="display:none;">批量互动</button>
                </div>
            </div>

            <div class="view-switcher">
                <button id="show-individual-view-btn" class="active">个人模式</button>
                <button id="show-group-view-btn">小组模式</button>
                <button id="show-shop-view-btn">爱心商城</button>
            </div>

            <div id="individual-view">
                <div class="garden-area">
                    <div class="sort-controls">
                        <label for="individual-sort-select">排序方式：</label>
                        <select id="individual-sort-select">
                            <option value="manual">默认排序 (可拖动)</option>
                            <option value="score_desc">按分数从高到低</option>
                            <option value="score_asc">按分数从低到高</option>
                            <option value="name_asc">按名字排序 (A-Z)</option>
                        </select>
                    </div>
                    <div class="garden-grid" id="garden-grid-individual"></div>
                </div>
            </div>

            <div id="group-view" style="display:none;">
                <div class="sort-controls">
                    <label for="group-sort-select">小组排序：</label>
                    <select id="group-sort-select">
                        <option value="manual">默认排序</option>
                        <option value="total_score_desc">按小组总分从高到低</option>
                        <option value="avg_score_desc">按小组平均互动数从高到低</option>
                        <option value="name_asc">按小组名称排序 (A-Z)</option>
                    </select>
                </div>
                <div id="group-view-container"></div>
            </div>

            <div id="shop-view" style="display:none;">
                <div class="shop-view-container" id="shop-view-container"></div>
            </div>
        </div>
    </div>

    <div id="unified-modal" class="modal-overlay">
        <div class="modal-content" id="create-class-modal-content" style="display:none;">
            <p>为新班级取个名字吧</p>
            <input type="text" id="new-class-name-input" placeholder="例如：一年级一班">
            <div>
                <button id="create-class-confirm-btn">创建</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
        <div class="modal-content" id="save-success-modal-content" style="display:none;">
            <p>保存成功！</p>
            <button id="modal-enter-garden-btn">进入宠物屋</button>
            <button class="cancel-btn">继续添加</button>
        </div>
        <div class="modal-content" id="confirm-modal-content" style="display:none;">
            <p id="confirm-modal-text">确认执行此操作吗？</p>
            <div>
                <button id="confirm-ok-btn">确定</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="rollback-modal" class="modal-overlay">
        <div class="modal-content">
            <p>将 <strong id="rollback-student-name"></strong> 的互动退回几次？</p>
            <input type="number" id="rollback-steps-input" class="modal-input" min="1" value="1">
            <div>
                <button id="confirm-rollback-btn">确认退回</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="add-score-modal" class="modal-overlay">
        <div class="modal-content">
            <p>给 <strong id="add-score-student-name"></strong> 增加互动次数</p>
            <input type="number" id="add-score-steps-input" class="modal-input" min="1" value="1">
            <div>
                <button id="confirm-add-score-btn">确认增加</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="reset-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p style="color:#c62828;font-weight:bold;">确认要归零吗？</p>
            <p id="reset-confirm-text" style="font-size:1rem;">此操作会清空所有学生的进度，且无法撤销！</p>
            <div>
                <button id="confirm-reset-all-btn" style="background-color:#c62828;">确认归零</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="group-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="group-editor-title">编辑小组成员</h3>
            <div id="group-editor-student-list"></div>
            <div>
                <button id="save-group-members-btn">保存更改</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="delete-group-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p style="color:#c62828;font-weight:bold;">确认删除小组吗？</p>
            <p id="delete-group-confirm-name"></p>
            <p>组内成员将变为“待分配”，此操作无法撤销。</p>
            <div>
                <button id="confirm-delete-group-btn" style="background-color:#c62828;">确认删除</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="penalty-group-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p style="color:#c62828;font-weight:bold;">确认扣分吗？</p>
            <p id="penalty-group-confirm-name"></p>
            <p>组内所有成员的进度都将退回一次！</p>
            <div>
                <button id="confirm-penalty-group-btn" style="background-color:#c62828;">确认扣分</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

            <div id="penalty-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p style="color:#c62828;font-weight:bold;">确认扣分</p>
            <p>该学生将清空当前爱心并重置宠物，是否继续？</p>
            <div>
                <button id="penalty-confirm-btn" style="background-color:#c62828;">确认扣分</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

        <div id="lv3-graduation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>恭喜养成 LV3！</h3>
            <div id="lv3-graduation-message" style="margin-bottom: 12px;"></div>
            <div id="lv3-graduation-badge" style="margin-bottom: 12px;"></div>
            <p id="graduation-student-name" style="display:none;"></p>
            <div>
                <button id="continue-current-pet-btn">继续当前宠物</button>
                <button id="change-pet-btn">更换宠物</button>
            </div>
        </div>
    </div>
<div id="pet-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:#f57c00;text-align:center;">选宠物</h3>
            <p id="pet-selection-message" style="text-align:center; margin-bottom: 12px;"></p>
            <div id="pet-selection-grid"></div>
            <div id="pet-selection-list" class="pet-selection-grid"></div>
            <div class="modal-actions">
                <button id="confirm-pet-selection-btn">确认更换</button>
                <button class="cancel-btn">取消</button>
            </div>
        </div>
    </div>
<div id="redeem-modal-overlay" class="modal-overlay">
        <div class="modal-content" id="redeem-modal-content">
            <div id="redeem-modal-header">
                <h3 id="redeem-modal-title">兑换奖励</h3>
                <button class="cancel-btn close-redeem-modal" type="button" style="background-color:#9e9e9e;">关闭</button>
            </div>
            <div id="redeem-student-info"></div>
            <div id="redeem-prize-list" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="redeem-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="redeem-confirm-text"></p>
            <div>
                <button id="confirm-redeem-btn" type="button" style="background-color:#ff9800;">确认兑换</button>
                <button id="cancel-redeem-btn" type="button" class="cancel-btn close-redeem-modal">取消</button>
            </div>
        </div>
    </div>

    <div id="class-password-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true">
            <h3 id="class-password-title">输入班级密码</h3>
            <p id="class-password-hint" style="margin:6px 0 10px;color:#666;">请输入进入该班级的密码</p>
            <input type="password" id="class-password-input" placeholder="请输入班级密码" autocomplete="off">
            <div id="class-password-error" class="input-error" aria-live="assertive"></div>
            <div class="modal-actions">
                <button id="class-password-cancel-btn" class="cancel-btn">取消</button>
                <button id="class-password-confirm-btn" style="background-color:#ff9800;color:#fff;">确认</button>
            </div>
        </div>
    </div>

    <footer class="page-footer">© 2025 邱妍 — 仅供本人教学使用</footer>
    <script src="{{ url_for('static', path='js/app.js') }}" defer></script>
</body>
</html>
